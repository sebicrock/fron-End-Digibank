<div class="payment-page">
  <div class="page-header">
    <button class="back-btn" (click)="volver()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round" />
      </svg>
      Volver al Perfil
    </button>

    <div class="header-content">
      <div class="header-icon">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M19 14V6C19 4.9 18.1 4 17 4H3C1.9 4 1 4.9 1 6V14C1 15.1 1.9 16 3 16H17C18.1 16 19 15.1 19 14ZM10 13C7.79 13 6 11.21 6 9C6 6.79 7.79 5 10 5C12.21 5 14 6.79 14 9C14 11.21 12.21 13 10 13ZM23 7V18C23 19.1 22.1 20 21 20H4C4 18.9 4.9 18 6 18H21V7C22.1 7 23 7.9 23 7Z"
            fill="currentColor" />
        </svg>
      </div>
      <div>
        <h1>Pago de Servicios</h1>
        <p class="subtitle">Paga tus servicios p√∫blicos y facturas de manera f√°cil y segura</p>
      </div>
    </div>
  </div>

  <div class="payment-container">

    <!-- CATEGOR√çAS DE SERVICIOS -->
    <div class="categories-section">
      <h2 class="section-title">Selecciona el tipo de servicio</h2>
      <div class="categories-grid">
        <div class="category-card" *ngFor="let categoria of categorias"
          [class.selected]="categoriaSeleccionada === categoria.id" (click)="seleccionarCategoria(categoria)">
          <div class="category-icon" [style.background]="categoria.color">
            <span>{{ categoria.icono }}</span>
          </div>
          <h3>{{ categoria.nombre }}</h3>
          <p>{{ categoria.descripcion }}</p>
        </div>
      </div>
    </div>

    <!-- FORMULARIO DE PAGO -->
    <div class="payment-form-section" *ngIf="categoriaSeleccionada">
      <form (ngSubmit)="onSubmit()" #paymentForm="ngForm">

        <!-- SELECCI√ìN DE EMPRESA -->
        <div class="form-section">
          <h2 class="section-title">
            <div class="title-icon">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M12 7V3H2V21H22V7H12ZM6 19H4V17H6V19ZM6 15H4V13H6V15ZM6 11H4V9H6V11ZM6 7H4V5H6V7ZM10 19H8V17H10V19ZM10 15H8V13H10V15ZM10 11H8V9H10V11ZM10 7H8V5H10V7ZM20 19H12V17H14V15H12V13H14V11H12V9H20V19ZM18 11H16V13H18V11ZM18 15H16V17H18V15Z"
                  fill="currentColor" />
              </svg>
            </div>
            <span>Informaci√≥n del Servicio</span>
          </h2>

          <div class="form-row">
            <div class="form-group full-width">
              <label for="empresa">Empresa/Proveedor <span class="required">*</span></label>
              <select id="empresa" name="empresa" [(ngModel)]="pagoData.empresa" required #empresa="ngModel"
                (change)="cargarDatosEmpresa()">
                <option value="">Seleccione la empresa...</option>
                <option *ngFor="let emp of getEmpresasPorCategoria()" [value]="emp.id">
                  {{ emp.nombre }}
                </option>
              </select>
              <small class="error-hint" *ngIf="empresa.invalid && empresa.touched">
                Debe seleccionar una empresa
              </small>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="numeroReferencia">N√∫mero de referencia/contrato <span class="required">*</span></label>
              <input type="text" id="numeroReferencia" name="numeroReferencia" [(ngModel)]="pagoData.numeroReferencia"
                placeholder="Ingrese el n√∫mero de referencia" required #numeroReferencia="ngModel">
              <small class="input-hint" *ngIf="numeroReferencia.valid">N√∫mero que aparece en tu factura</small>
              <small class="error-hint" *ngIf="numeroReferencia.invalid && numeroReferencia.touched">
                Este campo es obligatorio
              </small>
            </div>

            <div class="form-group">
              <label for="periodo">Per√≠odo a pagar</label>
              <input type="month" id="periodo" name="periodo" [(ngModel)]="pagoData.periodo" [max]="periodoActual">
              <small class="input-hint">Opcional: Mes y a√±o del servicio</small>
            </div>
          </div>

          <!-- BOT√ìN CONSULTAR FACTURA -->
          <div class="consult-section" *ngIf="pagoData.numeroReferencia && pagoData.empresa">
            <button type="button" class="btn-consult" (click)="consultarFactura()" [disabled]="consultando">
              <svg viewBox="0 0 24 24" fill="none" *ngIf="!consultando">
                <path
                  d="M15.5 14H14.71L14.43 13.73C15.41 12.59 16 11.11 16 9.5C16 5.91 13.09 3 9.5 3C5.91 3 3 5.91 3 9.5C3 13.09 5.91 16 9.5 16C11.11 16 12.59 15.41 13.73 14.43L14 14.71V15.5L19 20.49L20.49 19L15.5 14ZM9.5 14C7.01 14 5 11.99 5 9.5C5 7.01 7.01 5 9.5 5C11.99 5 14 7.01 14 9.5C14 11.99 11.99 14 9.5 14Z"
                  fill="currentColor" />
              </svg>
              <div class="spinner-small" *ngIf="consultando"></div>
              {{ consultando ? 'Consultando...' : 'Consultar Factura' }}
            </button>
            <!-- NUEVO BOT√ìN -->
            <button type="button" class="btn-consult" (click)="abrirDetallePagoServicios(pagoData.empresa)">
              Ver Detalle
            </button>

            <small class="consult-hint">Consultaremos el saldo pendiente de tu factura</small>
          </div>

          <!-- INFORMACI√ìN DE LA FACTURA CONSULTADA -->
          <div class="invoice-info" *ngIf="facturaConsultada">
            <div class="invoice-header">
              <div class="invoice-icon">üìÑ</div>
              <div>
                <h4>Factura Encontrada</h4>
                <p>{{ facturaConsultada.empresa }}</p>
              </div>
              <span class="invoice-status" [class.vencida]="facturaConsultada.vencida">
                {{ facturaConsultada.vencida ? 'Vencida' : 'Vigente' }}
              </span>
            </div>
            <div class="invoice-details">
              <div class="invoice-item">
                <span class="label">Referencia:</span>
                <span class="value">{{ facturaConsultada.referencia }}</span>
              </div>
              <div class="invoice-item">
                <span class="label">Per√≠odo:</span>
                <span class="value">{{ facturaConsultada.periodo }}</span>
              </div>
              <div class="invoice-item">
                <span class="label">Fecha vencimiento:</span>
                <span class="value" [class.vencida]="facturaConsultada.vencida">
                  {{ facturaConsultada.fechaVencimiento | date:'dd/MM/yyyy' }}
                </span>
              </div>
              <div class="invoice-item total">
                <span class="label">Total a pagar:</span>
                <span class="value">${{ facturaConsultada.monto | number:'1.0-0' }} COP</span>
              </div>
            </div>
          </div>
        </div>

        <!-- MONTO A PAGAR -->
        <div class="form-section">
          <h2 class="section-title">
            <div class="title-icon">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M11.8 10.9C9.53 10.31 8.8 9.7 8.8 8.75C8.8 7.66 9.81 6.9 11.5 6.9C13.28 6.9 13.94 7.75 14 9H16.21C16.14 7.28 15.09 5.7 13 5.19V3H10V5.16C8.06 5.58 6.5 6.84 6.5 8.77C6.5 11.08 8.41 12.23 11.2 12.9C13.7 13.5 14.2 14.38 14.2 15.31C14.2 16 13.71 17.1 11.5 17.1C9.44 17.1 8.63 16.18 8.52 15H6.32C6.44 17.19 8.08 18.42 10 18.83V21H13V18.85C14.95 18.48 16.5 17.35 16.5 15.3C16.5 12.46 14.07 11.49 11.8 10.9Z"
                  fill="currentColor" />
              </svg>
            </div>
            <span>Monto del Pago</span>
          </h2>

          <div class="form-row">
            <div class="form-group full-width">
              <label for="monto">Valor a pagar <span class="required">*</span></label>
              <div class="input-with-icon">
                <span class="currency">$</span>
                <input type="number" id="monto" name="monto" [(ngModel)]="pagoData.monto" placeholder="Ingrese el monto"
                  min="1000" required #monto="ngModel" [readonly]="facturaConsultada !== null">
              </div>
              <small class="input-hint" *ngIf="monto.valid && !facturaConsultada">Monto m√≠nimo: $1,000</small>
              <small class="input-hint" *ngIf="facturaConsultada" style="color: #10b981;">
                ‚úì Monto cargado autom√°ticamente desde la factura
              </small>
              <small class="error-hint" *ngIf="monto.invalid && monto.touched">
                Ingrese un monto v√°lido (m√≠nimo $1,000)
              </small>
            </div>
          </div>

          <!-- CAMPO DE CONVENIO (opcional) -->
          <div class="form-row" *ngIf="!facturaConsultada">
            <div class="form-group full-width">
              <label for="codigoConvenio">C√≥digo de convenio</label>
              <input type="text" id="codigoConvenio" name="codigoConvenio" [(ngModel)]="pagoData.codigoConvenio"
                placeholder="Opcional: si tienes c√≥digo de descuento">
              <small class="input-hint">Aplica descuentos o promociones especiales</small>
            </div>
          </div>
        </div>

        <!-- CUENTA DE D√âBITO -->
        <div class="form-section">
          <h2 class="section-title">
            <div class="title-icon">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M21 18V19C21 20.1 20.1 21 19 21H5C3.89 21 3 20.1 3 19V5C3 3.9 3.89 3 5 3H19C20.1 3 21 3.9 21 5V6H12C10.89 6 10 6.9 10 8V16C10 17.1 10.89 18 12 18H21ZM12 16H22V8H12V16ZM16 13.5C15.17 13.5 14.5 12.83 14.5 12C14.5 11.17 15.17 10.5 16 10.5C16.83 10.5 17.5 11.17 17.5 12C17.5 12.83 16.83 13.5 16 13.5Z"
                  fill="currentColor" />
              </svg>
            </div>
            <span>Cuenta de D√©bito</span>
          </h2>

          <div class="form-row">
            <div class="form-group full-width">
              <label for="cuentaDebito">Selecciona la cuenta <span class="required">*</span></label>
              <select id="cuentaDebito" name="cuentaDebito" [(ngModel)]="pagoData.cuentaDebito" required
                #cuentaDebito="ngModel">
                <option value="">Seleccione una cuenta...</option>
                <option *ngFor="let cuenta of cuentasDisponibles" [value]="cuenta.numeroCuenta">
                  {{ cuenta.tipoCuenta }} - **** {{ cuenta.numeroCuenta.slice(-4) }} - Saldo: ${{ cuenta.saldo |
                  number:'1.0-0' }}
                </option>
              </select>
              <small class="error-hint" *ngIf="cuentaDebito.invalid && cuentaDebito.touched">
                Debe seleccionar una cuenta
              </small>
            </div>
          </div>

          <!-- VALIDACI√ìN DE SALDO -->
          <div class="saldo-warning" *ngIf="pagoData.cuentaDebito && pagoData.monto && !saldoSuficiente()">
            <svg viewBox="0 0 24 24" fill="none">
              <path
                d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"
                fill="currentColor" />
            </svg>
            <span>Saldo insuficiente en la cuenta seleccionada</span>
          </div>
        </div>

        <!-- PROGRAMAR PAGO (OPCIONAL) -->
        <div class="form-section">
          <h2 class="section-title">
            <div class="title-icon">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M11.99 2C6.47 2 2 6.48 2 12C2 17.52 6.47 22 11.99 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 11.99 2ZM12 20C7.58 20 4 16.42 4 12C4 7.58 7.58 4 12 4C16.42 4 20 7.58 20 12C20 16.42 16.42 20 12 20ZM12.5 7H11V13L16.25 16.15L17 14.92L12.5 12.25V7Z"
                  fill="currentColor" />
              </svg>
            </div>
            <span>Opciones de Pago</span>
          </h2>

          <div class="payment-options">
            <label class="option-card" [class.selected]="!pagoData.programado">
              <input type="radio" name="tipoPago" [value]="false" [(ngModel)]="pagoData.programado">
              <div class="option-content">
                <div class="option-icon">‚ö°</div>
                <div>
                  <h4>Pago Inmediato</h4>
                  <p>El pago se realizar√° ahora mismo</p>
                </div>
              </div>
            </label>

            <label class="option-card" [class.selected]="pagoData.programado">
              <input type="radio" name="tipoPago" [value]="true" [(ngModel)]="pagoData.programado">
              <div class="option-content">
                <div class="option-icon">üìÖ</div>
                <div>
                  <h4>Programar Pago</h4>
                  <p>Elige cu√°ndo realizar el pago</p>
                </div>
              </div>
            </label>
          </div>

          <div class="form-row" *ngIf="pagoData.programado">
            <div class="form-group">
              <label for="fechaProgramada">Fecha de pago <span class="required">*</span></label>
              <input type="date" id="fechaProgramada" name="fechaProgramada" [(ngModel)]="pagoData.fechaProgramada"
                [min]="fechaMinima" [required]="pagoData.programado" #fechaProgramada="ngModel">
              <small class="error-hint" *ngIf="fechaProgramada.invalid && fechaProgramada.touched">
                Seleccione una fecha v√°lida
              </small>
            </div>

            <div class="form-group">
              <label for="recurrente">
                <input type="checkbox" id="recurrente" name="recurrente" [(ngModel)]="pagoData.recurrente">
                Pago recurrente
              </label>
              <small class="input-hint">El pago se repetir√° autom√°ticamente cada mes</small>
            </div>
          </div>
        </div>

        <!-- RESUMEN DEL PAGO -->
        <div class="payment-summary" *ngIf="pagoData.monto && pagoData.cuentaDebito">
          <div class="summary-icon">üí∞</div>
          <div class="summary-content">
            <h4>Resumen del Pago</h4>
            <div class="summary-details">
              <div class="summary-item">
                <span class="label">Servicio:</span>
                <span class="value">{{ getNombreEmpresa() }}</span>
              </div>
              <div class="summary-item">
                <span class="label">Referencia:</span>
                <span class="value">{{ pagoData.numeroReferencia }}</span>
              </div>
              <div class="summary-item">
                <span class="label">Cuenta a debitar:</span>
                <span class="value">**** {{ pagoData.cuentaDebito?.slice(-4) }}</span>
              </div>
              <div class="summary-item">
                <span class="label">Comisi√≥n:</span>
                <span class="value">${{ comision | number:'1.0-0' }} COP</span>
              </div>
              <div class="summary-item total">
                <span class="label">Total a pagar:</span>
                <span class="value">${{ (pagoData.monto + comision) | number:'1.0-0' }} COP</span>
              </div>
            </div>
            <p class="summary-note">{{ pagoData.programado ? 'El pago se realizar√° el ' + (pagoData.fechaProgramada |
              date:'dd/MM/yyyy') : 'El pago se realizar√° inmediatamente' }}</p>
          </div>
        </div>

        <!-- MENSAJE DE RESPUESTA -->
        <div *ngIf="mensaje" class="alert" [class.alert-success]="mensajeTipo === 'success'"
          [class.alert-error]="mensajeTipo === 'error'">
          <svg *ngIf="mensajeTipo === 'success'" viewBox="0 0 24 24" fill="none">
            <path d="M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z" fill="currentColor" />
          </svg>
          <svg *ngIf="mensajeTipo === 'error'" viewBox="0 0 24 24" fill="none">
            <path
              d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"
              fill="currentColor" />
          </svg>
          <span>{{ mensaje }}</span>
        </div>

        <!-- BOTONES DE ACCI√ìN -->
        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="volver()">
            <svg viewBox="0 0 24 24" fill="none">
              <path
                d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z"
                fill="currentColor" />
            </svg>
            <span>Cancelar</span>
          </button>
          <button type="submit" class="btn-primary"
            [disabled]="!paymentForm.valid || isSubmitting || !saldoSuficiente()">
            <span *ngIf="!isSubmitting">{{ pagoData.programado ? 'Programar Pago' : 'Realizar Pago' }}</span>
            <span *ngIf="isSubmitting" class="loading-content">
              <div class="spinner"></div>
              Procesando...
            </span>
            <svg *ngIf="!isSubmitting" viewBox="0 0 24 24" fill="none">
              <path d="M9 5L16 12L9 19" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>